<?phpdefined('BASEPATH') or die('No direct script access allowed');/** * @property Account $Account * @property Currency $Currency * @property Item $Item * @property Transaction $Transaction * @property Transaction_item $Transaction_item */class Quotations extends MY_Controller{    public $Transaction = NULL;    public $User = NULL;    public $Configuration = NULL;    public $Journal = NULL;    public $Journal_account = NULL;    public $Order = NULL;    public $Inbox = NULL;    public $Warehouse = NULL;    public function __construct()    {        parent::__construct();        // $this->pageTitle = $this->lang->line('quotations');        $this->load->model('Transaction');    }    public function index()    {        if ($this->input->is_ajax_request()) {            $this->_render_json($this->Transaction->load_quotations_data_tables(Transaction::QuatationTransType, false));        } else {            $this->session->unset_userdata('previous_url');            $this->session->set_userdata('previous_url', 'quotations/index');            // $this->pageTitle = $this->lang->line('Quotations');            $this->load->model('Transaction_item');            $data['records'] = $this->Transaction->paginate_quotations_data();            $data['title'] = $this->lang->line('quotations');            $this->load->view('templates/header', [                '_page_title' => "Quotations",                '_moreCss' => ['css/dataTables.bootstrap.min', 'css/fixedHeader.dataTables.min']            ]);            $this->load->view('quotations/index', $data);            $this->load->view('templates/footer', ['_moreJs' => ['jquery.dataTables.min', 'dataTables.bootstrap.min', 'dataTables.datetime.format', 'jquery.dataTable.pagination.input', 'quotations/index']]);            //$this->load->view('templates/footer', ['_moreJs' => ['jquery.dataTables.min', 'dataTables.bootstrap.min', 'dataTables.datetime.format', 'jquery.dataTable.pagination.input', 'order_purchases/index']]);        }    }    public function add()    {        $this->save(Transaction::QuatationTransType, 0);    }    public function edit($id = '0')    {        // var_dump($this->violet_auth->get_user_type());        // exit;        if ($this->violet_auth->get_user_type() !== 'Master Admin') {            $trans = $this->Transaction->check_if_user_can_edit($id);            if ($trans["check"] === 1) {                // if ($trans["edit_user_id"] !== $this->violet_auth->get_user_id()) {                // 	$this->Transaction->update_edit_user_id_and_locked($id, 1, $this->violet_auth->get_user_id());                // }                $this->save(Transaction::QuatationTransType, $id);            } else {                // var_dump($trans["edit_user_id"]);                // exit;                $this->load->model('User');                $user_name = $this->User->get_user_name($trans["edit_user_id"])['user_name'];                $this->session->set_flashdata('message', 'Warning: this quotation (#' . $trans["auto_no"] . ') is locked by ' . $user_name . '.');                redirect('quotations/index');            }        } else {            $this->save(Transaction::QuatationTransType, $id);        }    }    private function save($transType, $id = '0')    {        $fetched = ($id > 0 ? $this->Transaction->fetch(_gnv($id)) : false);        $post = $this->input->post(['trans', 'transItems', 'submitBtn'], true);        if ((!$fetched) and ($this->Transaction->set_next_auto_number($transType))) {            $this->Transaction->set_field('auto_no', $this->Transaction->set_next_auto_number($transType));        }        if ($post['submitBtn']) {            if ((!$fetched) and ($this->Transaction->set_next_auto_number($transType))) {                $post['trans']['auto_no'] = $this->Transaction->set_next_auto_number($transType);                $this->Transaction->set_field('user_id', $this->violet_auth->get_user_id());            }            if ($fetched) {                $post['trans']['trans_date'] = date('d-m-Y');            }            $this->Transaction->set_fields($post['trans']);            $this->Transaction->set_field('trans_type', $transType);            $this->Transaction->set_field('fiscal_year_id', $this->violet_auth->get_fiscal_year_id());            $this->Transaction->set_field('user2_id', $this->violet_auth->get_user_id());            if ($fetched) {                $this->Transaction->set_field('locked', 0);                $this->Transaction->set_field('edit_user_id', '');            }            $saved = $fetched ? $this->Transaction->update() : $this->Transaction->insert();            if ($saved) {                if (!$fetched) {                    $trans_id = $this->Transaction->fetch_transaction_id_by_autono($post['trans']['auto_no'], $transType);                    if ($post['transItems']) {                        $this->Transaction->save_transaction_items($post['transItems'], 0);                        $total = $this->Transaction->calculate_transaction_total($post['transItems'], $post['trans']['discount'], $post['trans']['TVA']);                        $this->Transaction->save_transaction_in_journals($post['trans'], $trans_id["0"]["id"], $total, "QU");                    } else {                        $this->Transaction->save_transaction_in_journals($post['trans'], $trans_id["0"]["id"], 0, "QU");                    }                    if ($post['submitBtn'] === "Save") {                        redirect('quotations/edit/' . $trans_id["0"]["id"]);                    } else {                        redirect('quotations/index');                    }                } elseif ($fetched) {                    //delete journal                    $this->load->model('Journal');                    $journal_id = $this->Journal->fetch_journal_id_by_transaction_id($this->Transaction->get_field('id'));                    if ($journal_id) {                        $this->Journal->delete($journal_id["id"]);                    }                    //insert journal                    if ($post['transItems']) {                        $total = $this->Transaction->calculate_transaction_total($post['transItems'], $post['trans']['discount'], $post['trans']['TVA']);                    } else {                        $total = 0;                    }                    $this->Transaction->save_transaction_in_journals($post['trans'], $this->Transaction->get_field('id'), $total, "QU");                    //delete trans_items                    $this->load->model('Transaction_item');                    $trans_items_id = $this->Transaction_item->fetch_trans_items_id_for_edit($this->Transaction->get_field('id'));                    foreach ($trans_items_id as $t) {                        $this->Transaction_item->delete($t["id"]);                    }                    //insert trans_items                    if ($post['transItems']) {                        $this->Transaction->save_transaction_items($post['transItems'], 0);                    }                    if ($post['submitBtn'] === "Save") {                        redirect('quotations/edit/' . $id);                    } else {                        redirect('quotations/index');                    }                    // redirect($this->session->userdata('previous_url'));                }            } elseif ($this->Transaction->is_valid()) {                redirect($this->session->userdata('previous_url'));            }        }        $data = $this->_load_related_models($fetched, $transType);        $data["back_url"] = $this->session->userdata('previous_url');        if ($fetched) {            $data["status"] = $this->Transaction->get_field('status');        } else {            $data["status"] = 0;        }        $this->load->view('templates/header', [            '_moreCss' => ['js/air-datepicker/css/datepicker.min'],            '_page_title' => $data['transTypeText']        ]);        $this->load->view('quotations/quotations_form', $data);        $this->load->view('templates/footer', [            '_moreJs' => [                'air-datepicker/js/datepicker.min', 'air-datepicker/js/i18n/datepicker.en',                'jquery.autocomplete.min', 'transactions/quotation', 'accounts/account_modal', 'items/item_modal'            ]        ]);    }    private function _load_related_models($fetched, $transType)    {        $data = [];        $this->load->model(['Currency', 'User']);        $data['transTypeText'] = ($fetched ? 'Edit ' : 'Add New ') . $this->Transaction->get_transaction_types_list()[$transType];        $data['transType'] = $this->Transaction->get_transaction_types_list()[$transType];        $data['currenciesList'] = $this->Currency->load_currencies_list();        $data['types'] = array(            "Individual" => "Individual", "Carage" => "Carage"        );        $data['account_type'] = array(            "Customer" => "Customer", "Supplier" => "Supplier",            "Cash" => "Cash", "Expenses" => "Expenses",            "Bank" => "Bank", "Sale VAT" => "Sale VAT",            "Purchase VAT" => "Purchase VAT"        );        $this->load->model('Warehouse');        $w = $this->Warehouse->load_warehouses_list();        $data['warehouse_list'][''] = '';        foreach ($w as $w1) {            $data['warehouse_list'][$w1] = $w1;        }        // var_dump($data['warehouse_list']);        // exit;        $this->load->model('Configuration');        $TVA1 = $this->Configuration->fetch_TVA1()["valueStr"];        $TVA2 = $this->Configuration->fetch_TVA2()["valueStr"];        $TVA = [0, doubleval($TVA1), doubleval($TVA2)];        $data['TVA'] = array_combine($TVA, $TVA);        $this->load->model('Warehouse');        $w = $this->Warehouse->load_warehouses_list();        $warehouses_list = array_combine($w, $w);        if ($fetched) {            $this->load->model('Account');            $account = $this->Account->load($this->Transaction->get_field('account_id'));            $data['account'] = "{$account['account_number']} - {$account['account_name']}";            $account2 = $this->Account->load($this->Transaction->get_field('account2_id'));            $data['account2'] = "{$account2['account_number']} - {$account2['account_name']}";            $this->load->model('Transaction_item');            $data['trans_items'] = $this->Transaction_item->load_all_trans_items_for_QO_AND_OS($this->Transaction->get_field('id'));            $data['warehouses_list'] = [];            foreach ($data['trans_items'] as $i => $t) {                if ($t["warehouse_id"] !== '0') {                    $warehouse_shelf = $this->Warehouse->fetch_warehouse_and_shelf($t["warehouse_id"]);                    $data['warehouse'][$i] = $warehouse_shelf['warehouse'];                    $data['shelf'][$i] = $warehouse_shelf['shelf'];                    $result = $this->Warehouse->fetch_item_in_inventory($t["item_id"]);                    if ($result !== []) {                        $data['warehouses_list'][$i][$warehouse_shelf['warehouse']] = $warehouse_shelf['warehouse'];                        foreach ($result as $r) {                            $data['warehouses_list'][$i][$r["warehouse"]] = $r["warehouse"];                        }                        $shelfs = $this->Warehouse->fetch_item_warehouse_shelfs($t["item_id"], $warehouse_shelf['warehouse']);                        $data['shelf_list'][$i][$warehouse_shelf['shelf']] = $warehouse_shelf['shelf'];                        foreach ($shelfs as $s) {                            $data['shelf_list'][$i][$s['shelf']] = $s['shelf'];                        }                    } else {                        $order_warehouses = $this->Warehouse->fetch_all_order_warehouses();                        foreach ($order_warehouses as $o) {                            $data['warehouses_list'][$i][$o["warehouse"]] = $o["warehouse"];                        }                        $order_shelfs = $this->Warehouse->fetch_shelf_of_order_warehouse($warehouse_shelf['warehouse']);                        foreach ($order_shelfs as $os) {                            $data['shelf_list'][$i][$os['shelf']] = $os['shelf'];                        }                    }                } else {                    $data['warehouses_list'][$i] = $warehouses_list;                    $shelfs = $this->Warehouse->load_all_shelfs_of_warehouse($w[0]);                    foreach ($shelfs as $s) {                        $data['shelf_list'][$i][$s['shelf']] = $s['shelf'];                    }                    $data['warehouse'][$i] = '';                    $data['shelf'][$i] = '';                }            }            $data['trans_date'] = $this->Transaction->get_field('trans_date');            $data['value_date'] = $this->Transaction->get_field('value_date');            $data['user_add'] = $this->User->get_user_name($this->Transaction->get_field('user_id'))['user_name'];            $data['user_edit'] = $this->User->get_user_name($this->Transaction->get_field('user2_id'))['user_name'];            $data['created_on'] = $this->Transaction->get_transaction_created_on_field($this->Transaction->get_field('id'))['created_on'];        } else {            $data['account'] = '';            $data['account2'] = '';            $data['trans_items'] = [];            $data['trans_date'] = date("d-m-Y");            $data['value_date'] = date("d-m-Y");            $data['user_add'] = '';            $data['user_edit'] = '';            $data['created_on'] = '';        }        return $data;    }    public function delete($id)    {        if ($this->Transaction->delete($id)) {            // $this->add_msg($this->lang->line('record_deleted'), 'success');            redirect('quotations/index');        } else {            // $this->add_msg($this->lang->line('record_not_deleted'), 'warning');            redirect('quotations/index');        }    }    public function lookup_accounts()    {        $this->load->model('Account');        $this->_render_json(            $this->Account->search_suggestions(trim($this->input->get('query', true)))        );    }    public function lookup_items()    {        $this->load->model('Item');        $this->_render_json(            $this->Item->search_suggestions(trim($this->input->get('query', true)))        );    }    public function add_to_order($id)    {        $ordered = $this->Transaction->check_if_quotation_transfered_to_order($id);        $case = 0;        if ($ordered) {            if (!$ordered['id']) {                $case = 1;            }        } else {            $case = 1;        }        if ($case == 1) {            $transType = "OS";            $fetched = ($id > 0 ? $this->Transaction->fetch(_gnv($id)) : false);            $post = $this->input->post(['trans', 'transItems', 'submitBtn'], true);            if (($fetched) and ($this->Transaction->set_next_auto_number($transType))) {                $this->Transaction->set_field('auto_no', $this->Transaction->set_next_auto_number($transType));            }            if ($post['submitBtn']) {                $customer_acc = $post['trans']['account_id'];                $post['trans']['auto_no'] = $this->Transaction->set_next_auto_number($transType);                $this->Transaction->set_fields($post['trans']);                $this->Transaction->set_field('id', '');                $this->Transaction->set_field('relation_id', $id);                $this->Transaction->set_field('trans_type', $transType);                $this->Transaction->set_field('fiscal_year_id', $this->violet_auth->get_fiscal_year_id());                $this->Transaction->set_field('user_id', $this->violet_auth->get_user_id());                $this->Transaction->set_field('user2_id', $this->violet_auth->get_user_id());                $saved = $this->Transaction->insert();                if ($saved) {                    $this->Transaction->save_transaction_items($post['transItems'], 0);                    $total = $this->Transaction->calculate_transaction_total($post['transItems'], $post['trans']['discount'], $post['trans']['TVA']);                    $trans_id = $this->Transaction->fetch_transaction_id_by_autono($post['trans']['auto_no'], $transType);                    $this->Transaction->save_transaction_in_journals($post['trans'], $trans_id["0"]["id"], $total, $transType);                    $this->Transaction->update_transfered($id, 1);                    $this->load->model('Item');                    $data['trans_items'] = $this->Transaction_item->load_all_trans_items_for_QO_AND_OS($this->Transaction->get_field('id'));                    $ops = [];                    foreach ($post['transItems'] as $k => $p) {                        $OP = [];                        $item = $this->Item->load_item_data($p['item_id']);                        $OP = $p;                        $OP['cost'] = 0;                        $OP['item_cost'] = $item[0]['cost'];                        $OP['price'] = $item[0]['cost'];                        $OP['item_profit'] = 0;                        $ops[$p['account_id']][] = $OP;                    }                    $order_sale_id = $trans_id["0"]["id"];                    foreach ($ops as $supplier => $op) {                        $order_purchase = $this->Transaction->load_transaction_by_date_and_type('OP', date('Y-m-d'), $supplier);                        if (!$order_purchase) {                            $this->Transaction->reset_fields();                            $post['trans']['auto_no'] = $this->Transaction->set_next_auto_number('OP');                            $post['trans']['account_id'] = $supplier;                            $this->load->model('Account');                            $sup_data = $this->Account->load_account_data($supplier);                            $this->load->model('Currency');                            $currency = $this->Currency->load_currency_data($sup_data['currency_id']);                            $purchases_acc = $this->Account->load_account_by_account_type_and_currency_id('Purchases', $sup_data['currency_id']);                            $post['trans']['account2_id'] = $purchases_acc['id'];                            $this->Transaction->set_fields($post['trans']);                            $this->Transaction->set_field('id', '');                            $this->Transaction->set_field('account2_id', $purchases_acc['id']);                            $this->Transaction->set_field('currency_id', $sup_data['currency_id']);                            $this->Transaction->set_field('currency_rate', $currency['currency_rate']);                            $this->Transaction->set_field('trans_type', 'OP');                            $this->Transaction->set_field('order_id', $order_sale_id);                            $this->Transaction->set_field('fiscal_year_id', $this->violet_auth->get_fiscal_year_id());                            $this->Transaction->set_field('user_id', $this->violet_auth->get_user_id());                            $this->Transaction->set_field('user2_id', $this->violet_auth->get_user_id());                            $saved2 = $this->Transaction->insert();                            if ($saved2) {                                foreach ($op as $i) {                                    $warehouse_id = $this->Warehouse->get_warehouse_id_by_warehouse_and_shelf($i["warehouses"], $i["shelfs"]);                                    $this->Transaction_item->reset_fields();                                    $this->Transaction_item->set_fields($i);                                    $this->Transaction_item->set_field('transaction_id', $this->Transaction->get_field('id'));                                    $this->Transaction_item->set_field('warehouse_id', $warehouse_id["id"]);                                    $this->Transaction_item->set_field('account_id', $customer_acc);                                    $this->Transaction_item->set_field('discount', "0");                                    $this->Transaction_item->set_field('mvt_type', "0");                                    $this->Transaction_item->set_field('net_cost', "0");                                    $this->Transaction_item->set_field('relation_id', $order_sale_id);                                    $res = $this->Transaction_item->insert();                                    $this->Transaction_item->update_trans_item_relation_id($order_sale_id, $i['item_id'], $this->Transaction->get_field('id'));                                }                                $total = $this->Transaction->calculate_transaction_total($post['transItems'], $post['trans']['discount'], $post['trans']['TVA']);                                $this->load->model('Journal');                                $this->Journal->reset_fields();                                $this->Transaction->save_transaction_in_journals($post['trans'], $this->Transaction->get_field('id'), $total, 'OP');                            }                        } else {                            foreach ($op as $i) {                                $warehouse_id = $this->Warehouse->get_warehouse_id_by_warehouse_and_shelf($i["warehouses"], $i["shelfs"]);                                $this->Transaction_item->reset_fields();                                $this->Transaction_item->set_fields($i);                                $this->Transaction_item->set_field('transaction_id', $order_purchase['id']);                                $this->Transaction_item->set_field('warehouse_id', $warehouse_id["id"]);                                $this->Transaction_item->set_field('account_id', $customer_acc);                                $this->Transaction_item->set_field('discount', "0");                                $this->Transaction_item->set_field('mvt_type', "0");                                $this->Transaction_item->set_field('net_cost', "0");                                $this->Transaction_item->set_field('relation_id', $order_sale_id);                                $this->Transaction_item->insert();                            }                        }                    }                    redirect('orders/index');                }            }            $data = $this->_load_add_to_order_related_models($fetched, $transType);            $data['transTypeText'] = "Quotation to Order";            $data["status"] = 0;            $this->load->view('templates/header', [                '_moreCss' => ['js/air-datepicker/css/datepicker.min'],                '_page_title' => $data['transTypeText']            ]);            $this->load->view('qu_to_os/order_form', $data);            $this->load->view('templates/footer', [                '_moreJs' => [                    'air-datepicker/js/datepicker.min', 'air-datepicker/js/i18n/datepicker.en',                    'jquery.autocomplete.min', 'transactions/qu_to_os', 'accounts/account_modal', 'items/item_modal'                ]            ]);        } else {            $this->session->set_flashdata('message', 'Warning: this quotation was already transferd to order.');            redirect('quotations/index');        }    }    private function _load_add_to_order_related_models($fetched, $transType)    {        $data = [];        $this->load->model('Account');        $suppliers = $this->Account->load_all_accounts_by_account_type("Supplier");        $data['suppliers'] = [];        foreach ($suppliers as $s) {            $data['suppliers'][$s['id']] = $s['account_name'];        }        $this->load->model(['Currency', 'User']);        $data['transTypeText'] = ($fetched ? 'Edit ' : 'Add New ') . $this->Transaction->get_transaction_types_list()[$transType];        $data['transType'] = $this->Transaction->get_transaction_types_list()[$transType];        $data['currenciesList'] = $this->Currency->load_currencies_list();        $data['types'] = array(            "Individual" => "Individual", "Carage" => "Carage"        );        $data['account_type'] = array(            "Customer" => "Customer", "Supplier" => "Supplier",            "Cash" => "Cash", "Expenses" => "Expenses",            "Bank" => "Bank", "Sale VAT" => "Sale VAT",            "Purchase VAT" => "Purchase VAT"        );        $data["delivery_type"] = array(            " " => " ", "Delivery" => "SLATS Delivery",            "Self Pickup" => "Self Pickup", "DHL" => "DHL", "Post" => "Post"        );        $this->load->model('Warehouse');        $w = $this->Warehouse->load_warehouses_list();        $data['warehouse_list'] = array_combine($w, $w);        $this->load->model('Configuration');        $TVA1 = $this->Configuration->fetch_TVA1()["valueStr"];        $TVA2 = $this->Configuration->fetch_TVA2()["valueStr"];        $TVA = [0, doubleval($TVA1), doubleval($TVA2)];        $data['TVA'] = array_combine($TVA, $TVA);        $drivers = $this->User->load_all_users_with_type_driver();        $employees = $this->User->load_all_users_with_type_employee();        $data['drivers'] = [0 => ""];        foreach ($drivers as $d) {            $data['drivers'][$d["id"]] = $d["user_name"];        }        $data['employees'] = [0 => ""];        foreach ($employees as $e) {            $data['employees'][$e["id"]] = $e["user_name"];        }        if ($fetched) {            $this->load->model('Account');            $account = $this->Account->load($this->Transaction->get_field('account_id'));            $data['account'] = "{$account['account_number']} - {$account['account_name']}";            $account2 = $this->Account->load($this->Transaction->get_field('account2_id'));            $data['account2'] = "{$account2['account_number']} - {$account2['account_name']}";            $this->load->model('Transaction_item');            $data['trans_items'] = $this->Transaction_item->load_all_trans_items_for_QO_AND_OS($this->Transaction->get_field('id'));            $data['trans_date'] = date("d-m-Y");            $data['value_date'] = date("d-m-Y");            foreach ($data['trans_items'] as $i => $t) {                if ($t['warehouse_id'] == 0) {                    $data['warehouse'][$i] = '';                    $data['shelf'][$i] = '';                    $shelfs = $this->Warehouse->load_all_shelfs_of_warehouse($w[0]);                    foreach ($shelfs as $s) {                        $data['shelf_list'][$i][$s['shelf']] = $s['shelf'];                    }                } else {                    $ws = $this->Warehouse->fetch_warehouse_and_shelf($t['warehouse_id']);                    $data['warehouse'][$i] = $ws['warehouse'];                    $data['shelf'][$i] = $ws['shelf'];                    $shelfs = $this->Warehouse->load_all_shelfs_of_warehouse($ws['warehouse']);                    foreach ($shelfs as $s) {                        $data['shelf_list'][$i][$s['shelf']] = $s['shelf'];                    }                }                // var_dump($ws, $data['warehouse'], $data['shelf'], $data['shelf_list']);            }            // exit;            // foreach ($data['trans_items'] as $i => $t) {            // 	$result = $this->Warehouse->fetch_item_in_inventory($t["item_id"]);            // 	if ($result !== []) {            // 		foreach ($result as $r) {            // 			$data['warehouses_list'][$i][$r["warehouse"]] = $r["warehouse"];            // 		}            // 	} else {            // 		$order_warehouses = $this->Warehouse->fetch_all_order_warehouses();            // 		foreach ($order_warehouses as $o) {            // 			$data['warehouses_list'][$i][$o["warehouse"]] = $o["warehouse"];            // 		}            // 	}            // }        } else {            $data['account'] = '';            $data['account2'] = '';            $data['trans_items'] = [];            $data['trans_date'] = date("d-m-Y");            $data['value_date'] = date("d-m-Y");        }        return $data;    }    public function preview($id)    {        $this->load->model('Account');        $this->load->model('Transaction_item');        $this->load->model('Configuration');        $this->load->model('Currency');        $this->load->model('Warehouse');        $data['trans'] = $this->Transaction->load_trans_data_by_trans_id($id);        $data['customer_info'] = $this->Account->fetch_account_info($data['trans']["account_id"]);        $data['sales_info'] = $this->Account->fetch_account_info($data['trans']["account2_id"]);        $data['trans_items'] = $this->Transaction_item->load_all_trans_items_for_QO_AND_OS($id);        $total = 0;        $subtotal = 0;        $tva_amount = 0;        $subtot = 0;        foreach ($data['trans_items'] as $k => $t) {            $res = $this->Warehouse->fetch_warehouse_and_shelf($t['warehouse_id']);            $data['trans_items'][$k]["warehouse"] = $res["warehouse"] ?? '';            $data['trans_items'][$k]["shelf"] = $res["shelf"] ?? '';            $data['trans_items'][$k]["total"] = doubleval($t["price"]) * doubleval($t["qty"]) * (1 - (doubleval($t["discount"]) / 100));            $subtotal += $data['trans_items'][$k]["total"];            $data['trans_items'][$k]["sub_total"] = doubleval($t["price"]) * doubleval($t["qty"]);        }        $sub_total = $subtotal;        $data['sub_total'] = number_format($sub_total, 2, '.', '');        $tva_amount = ($subtotal + doubleval($data['trans']['delivery_charge'])) * (doubleval($data['trans']['TVA']) / 100);        $data['tva_amount'] = number_format($tva_amount, 2, '.', '');        $total = (($subtotal + doubleval($data['trans']['delivery_charge']) - doubleval($data['trans']["discount"])) * (1 + (doubleval($data['trans']['TVA']) / 100))) + doubleval($data['trans']["pfand"]);        $data['total'] = number_format($total, 2, '.', '');        $data['company_name'] = $this->Configuration->fetch_company_name()["valueStr"];        $data['company_address'] = $this->Configuration->fetch_company_address()["valueStr"];        $data['company_phone'] = $this->Configuration->fetch_company_phone()["valueStr"];        $data['company_email'] = $this->Configuration->fetch_company_email()["valueStr"];        $data['company_website'] = $this->Configuration->fetch_company_website()["valueStr"];        $data['currency'] = $this->Currency->fetch_currency_code($data['trans']["currency_id"])["currency_code"];        $data['title'] = "Quotation";        $data['pfand_note'] = "Austauschartikel (zzgl. " . $data['trans']['pfand'] . " " . $data['currency'] . " Pfand / exkl. 7.7% MwSt) wird dem Kunden bei der Rücksendung des Altteils zurückerstattet";        $this->load->view('templates/header', [            '_moreCss' => ['js/air-datepicker/css/datepicker.min'],            '_page_title' => "Print"        ]);        $this->load->view('quotations/preview', $data);        $this->load->view('templates/footer', [            '_moreJs' => [                'air-datepicker/js/datepicker.min', 'air-datepicker/js/i18n/datepicker.en',                'jquery.autocomplete.min', 'quotations/preview'            ]        ]);    }    public function view($id)    {        $data = [];        $this->load->model(['Currency', 'User', 'Account', 'Transaction_item']);        $data['transType'] = $this->Transaction->get_transaction_types_list()[Transaction::QuatationTransType];        $data['currenciesList'] = $this->Currency->load_currencies_list();        $data['trans'] = $this->Transaction->load_trans_data_by_trans_id($id);        $account = $this->Account->load($data['trans']['account_id']);        $data['account'] = "{$account['account_number']} - {$account['account_name']}";        $account2 = $this->Account->load($data['trans']['account2_id']);        $data['account2'] = "{$account2['account_number']} - {$account2['account_name']}";        $data['trans_items'] = $this->Transaction_item->load_all_trans_items_for_QO_AND_OS($id);        $subtotal = 0;        foreach ($data['trans_items'] as $k => $t) {            $data['trans_items'][$k]["total"] = doubleval($t["price"]) * doubleval($t["qty"]) * (1 - (doubleval($t["discount"]) / 100));            $subtotal += $data['trans_items'][$k]["total"];            $data['trans_items'][$k]["sub_total"] = doubleval($t["price"]) * doubleval($t["qty"]);        }        $data['final_subtotal'] = number_format($subtotal, 2, '.', '');        $total = (($subtotal + doubleval($data['trans']['delivery_charge'])) * (1 + (doubleval($data['trans']['TVA']) / 100))) - doubleval($data['trans']["discount"]) + doubleval($data['trans']["pfand"]);        $data['final_total'] = number_format($total, 2, '.', '');        $data['user_add'] = isset($data['trans']['user_id']) ? $this->User->get_user_name($data['trans']['user_id'])['user_name'] : '';        $data['user_edit'] = isset($data['trans']['user2_id']) ? $this->User->get_user_name($data['trans']['user2_id'])['user_name'] : '';        $data['transTypeText'] = "Quotation View";        $this->load->view('templates/header', [            '_page_title' => $data['transTypeText']        ]);        $this->load->view('quotations/view', $data);        $this->load->view('templates/footer', [            '_moreJs' => [                'air-datepicker/js/datepicker.min', 'air-datepicker/js/i18n/datepicker.en',                'jquery.autocomplete.min', 'quotations/index'            ]        ]);    }    public function exit($id)    {        $this->Transaction->update_edit_user_id_and_locked($id, 0, '');        redirect('quotations/index');    }    public function exit_page_js()    {        $id = $this->input->post('trans_id');        $trans = $this->Transaction->check_if_user_can_edit($id);        if ($trans["edit_user_id"] === $this->violet_auth->get_user_id()) {            $this->Transaction->update_edit_user_id_and_locked($id, 0, '');        }    }    public function open_page_js()    {        $id = $this->input->post('trans_id');        $trans = $this->Transaction->check_if_user_can_edit($id);        if ($trans["locked"] !== "1") {            $this->Transaction->update_edit_user_id_and_locked($id, 1, $this->violet_auth->get_user_id());        }    }    public function to_invoice($id)    {        $transType = "SA";        $fetched = ($id > 0 ? $this->Transaction->fetch(_gnv($id)) : false);        $post = $this->input->post(['trans', 'transItems', 'submitBtn'], true);        if (($fetched) and ($this->Transaction->set_next_auto_number($transType))) {            $this->Transaction->set_field('auto_no', $this->Transaction->set_next_auto_number($transType));        }        if ($post['submitBtn']) {            $post['trans']['auto_no'] = $this->Transaction->set_next_auto_number($transType);            $this->Transaction->set_fields($post['trans']);            $this->Transaction->set_field('id', '');            $this->Transaction->set_field('relation_id', $id);            $this->Transaction->set_field('trans_type', $transType);            $this->Transaction->set_field('fiscal_year_id', $this->violet_auth->get_fiscal_year_id());            $this->Transaction->set_field('user_id', $this->violet_auth->get_user_id());            $this->Transaction->set_field('user2_id', $this->violet_auth->get_user_id());            $saved = $this->Transaction->insert();            if ($saved) {                $this->Transaction->save_transaction_items($post['transItems'], -1);                $total = $this->Transaction->calculate_transaction_total($post['transItems'], $post['trans']['discount'], $post['trans']['TVA']);                $trans_id = $this->Transaction->fetch_transaction_id_by_autono($post['trans']['auto_no'], $transType);                $this->Transaction->save_transaction_in_journals($post['trans'], $trans_id["0"]["id"], $total, "SA");                $this->load->model('Account');                $journal_id = $this->Transaction->fetch_journal_id_by_transaction_id($trans_id["0"]["id"], $transType);                $name1 = $this->Account->fetch_account_name_by_id($post['trans']['account_id']);                $name2 = $this->Account->fetch_account_name_by_id($post['trans']['account2_id']);                $this->Transaction->save_in_journal_accounts($journal_id["0"]["id"], $post['trans']['account2_id'], $post['trans']['auto_no'], $total, "-1", $name1["0"]["account_name"], "Sale");                $this->Transaction->save_in_journal_accounts($journal_id["0"]["id"], $post['trans']['account_id'], $post['trans']['auto_no'], $total, "1", $name2["0"]["account_name"], "Sale");                //update items qty                $this->Transaction->update_items_qty($post['transItems']);                $this->load->model('Journal');                //update balance debit credit for account 1                $balance = $this->Journal->calculate_account_balance($post['trans']['account_id'])["total"];                $credit = $this->Journal->calculate_account_credit($post['trans']['account_id'])["total"];                $debit = $this->Journal->calculate_account_debit($post['trans']['account_id'])["total"];                $this->Account->update_account_credit_debit_balance($post['trans']['account_id'], $balance, $credit, $debit);                //update balance debit credit for account 2                $balance = $this->Journal->calculate_account_balance($post['trans']['account2_id'])["total"];                $credit = $this->Journal->calculate_account_credit($post['trans']['account2_id'])["total"];                $debit = $this->Journal->calculate_account_debit($post['trans']['account2_id'])["total"];                $this->Account->update_account_credit_debit_balance($post['trans']['account2_id'], $balance, $credit, $debit);                //$this->Transaction->update_status($id);                $this->Transaction->update_to_invoice($id);                redirect('sales/index');            } elseif ($this->Transaction->is_valid()) {                redirect('sales/index');            }        }        $this->load->model('Item');        $data = $this->_load_related_models_for_to_invoice($fetched, $transType);        $data["status"] = 0;        $data['transTypeText'] = "Quotation to Invoice";        $this->load->view('templates/header', [            '_moreCss' => ['js/air-datepicker/css/datepicker.min'],            '_page_title' => $data['transTypeText']        ]);        $this->load->view('order_to_invoice/form', $data);        $this->load->view('templates/footer', [            '_moreJs' => [                'air-datepicker/js/datepicker.min', 'air-datepicker/js/i18n/datepicker.en',                'jquery.autocomplete.min', 'transactions/ordertoinvoice', 'accounts/account_modal', 'items/item_modal'            ]        ]);    }    private function _load_related_models_for_to_invoice($fetched, $transType)    {        $data = [];        $this->load->model(['Currency', 'User']);        $data['transTypeText'] = ($fetched ? 'Edit ' : 'Add New ') . $this->Transaction->get_transaction_types_list()[$transType];        $data['transType'] = $this->Transaction->get_transaction_types_list()[$transType];        $data['currenciesList'] = $this->Currency->load_currencies_list();        $data['types'] = array(            "Individual" => "Individual", "Carage" => "Carage"        );        $data['account_type'] = array(            "Customer" => "Customer", "Supplier" => "Supplier",            "Cash" => "Cash", "Expenses" => "Expenses",            "Bank" => "Bank", "Sale VAT" => "Sale VAT",            "Purchase VAT" => "Purchase VAT"        );        $data["delivery_type"] = array(            " " => " ", "Delivery" => "SLATS Delivery",            "Self Pickup" => "Self Pickup", "DHL" => "DHL", "Post" => "Post"        );        $data["payment_methods"] = array(            " " => " ", "Cash" => "Cash", "TWINT" => "TWINT", "PayPal" => "PayPal",            "Postcard" => "Postcard", "Bank Transfer" => "Bank Transfer"        );        $this->load->model('Configuration');        $TVA1 = $this->Configuration->fetch_TVA1()["valueStr"];        $TVA2 = $this->Configuration->fetch_TVA2()["valueStr"];        $TVA = [0, doubleval($TVA1), doubleval($TVA2)];        $data['TVA'] = array_combine($TVA, $TVA);        $drivers = $this->User->load_all_users_with_type_driver();        $employees = $this->User->load_all_users_with_type_employee();        $data['drivers'] = [0 => ""];        foreach ($drivers as $d) {            $data['drivers'][$d["id"]] = $d["user_name"];        }        $data['employees'] = [0 => ""];        foreach ($employees as $e) {            $data['employees'][$e["id"]] = $e["user_name"];        }        $this->load->model('Warehouse');        $w = $this->Warehouse->load_warehouses_list();        $data['warehouse_list'] = array_combine($w, $w);        $data['trans_date'] = date("d-m-Y");        $add_days = 6;        $data['value_date'] = date('d-m-Y', strtotime($data['trans_date']) + (24 * 3600 * $add_days));        if ($fetched) {            $this->load->model('Account');            $account = $this->Account->load($this->Transaction->get_field('account_id'));            $data['account'] = "{$account['account_number']} - {$account['account_name']}";            $account2 = $this->Account->load($this->Transaction->get_field('account2_id'));            $data['account2'] = "{$account2['account_number']} - {$account2['account_name']}";            $this->load->model('Transaction_item');            $data['trans_items'] = $this->Transaction_item->load_all_trans_items_for_QO_AND_OS($this->Transaction->get_field('id'));            if ($data['trans_items'] !== []) {                $missing_products = $this->Item->find_missing_products($data['trans_items']);            }            $data['warehouse'] = [];            $data['shelf'] = [];            $data['shelf_list'] = [];            foreach ($data['trans_items'] as $k => $t) {                $res = $this->Warehouse->fetch_warehouse_and_shelf($t["warehouse_id"]);                // var_dump($t, $res);exit;                $data['warehouse'][$k] = $res['warehouse'] ?? '';                $data['shelf'][$k] = $res['shelf'] ?? '';                if (isset($res['warehouse'])) {                    $s = $this->Warehouse->fetch_all_warehouse_shelfs($res['warehouse']);                    $s = array_combine($s, $s);                    array_push($data['shelf_list'], $s);                }            }        } else {            $data['account'] = '';            $data['account2'] = '';            $data['trans_items'] = [];        }        return $data;    }    public function get_last_sale_price_of_item()    {        $item_id = $this->input->post('item_id');        $price = $this->input->post('price');        $res = $this->Transaction->fetch_last_trans_date_of_sale_of_item($item_id);        if ($res) {            $result = $this->Transaction->fetch_last_sale_of_item_using_trans_date($item_id, $res['trans_date']);            if ($result) {                $this->load->model('Transaction_item');                $trans_item = $this->Transaction_item->fetch_trans_item_data($result['transaction_item_id']);                $price = $trans_item['price'];            }        }        echo $price;        // $this->_render_json(        // 	$price        // );    }    public function change_status()    {        $itemId = $this->input->post('itemId');        $status = 0;        $item = $this->Transaction->load_trans_data_by_trans_id($itemId);        if ($item['status'] == 0) {            $status = 1;        } elseif ($item['status'] == 1) {            $status = 0;        }        $data = array(            'status' => $status        );        $this->db->where('id', $itemId);        $this->db->update('transactions', $data);    }}